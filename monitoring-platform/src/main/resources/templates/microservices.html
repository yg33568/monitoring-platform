<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»„ä»¶ç›‘æ§ - æ™ºèƒ½è¿ç»´å¹³å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .component-card {
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        cursor: pointer;
    }
    .component-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .sidebar {
        background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
        color: white;
        height: 100vh;
        position: fixed;
        transition: width 0.3s;
    }
    .main-content {
        margin-left: 250px;
        padding: 20px;
        transition: margin-left 0.3s;
    }
    .space-tree {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
    }
    .tree-item {
        margin: 2px 0;
    }
    .tree-icon {
        margin-right: 5px;
    }
    @media (max-width: 768px) {
        .sidebar {
            width: 60px;
        }
        .main-content {
            margin-left: 60px;
        }
        .sidebar .nav-link span, .sidebar h4 span {
            display: none;
        }
        .sidebar h4 {
            font-size: 1.2rem;
            text-align: center;
        }
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- ä¾§è¾¹æ  -->
    <nav class="col-md-3 col-lg-2 d-md-block sidebar">
      <div class="position-sticky pt-3">
        <h4 class="text-center mb-4">
          <i class="bi bi-graph-up"></i>
          <span>æ™ºèƒ½è¿ç»´å¹³å°</span>
        </h4>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active text-white bg-primary bg-opacity-30" href="/microservices">
              <i class="bi bi-diagram-3"></i>
              <span>ç»„ä»¶ç›‘æ§</span>
            </a >
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/interactive-dashboard">
              <i class="bi bi-display"></i>
              <span>ç›‘æ§å¤§å±</span>
            </a >
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/history">
              <i class="bi bi-clock-history"></i>
              <span>å†å²æ•°æ®</span>
            </a >
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/analysis">
              <i class="bi bi-search"></i>
              <span>æ ¹å› åˆ†æ</span>
            </a >
          </li>
        </ul>
      </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
          <i class="bi bi-diagram-3 me-2"></i>
          ç”µè„‘ç»„ä»¶ç›‘æ§
        </h1>
      </div>

      <p class="text-muted">ç³»ç»Ÿå„ç»„ä»¶è¿è¡ŒçŠ¶æ€ç›‘æ§</p >

      <!-- æ ¸å¿ƒç»„ä»¶çŠ¶æ€ç½‘æ ¼ -->
      <div class="row">
        <div class="col-md-4 mb-4">
          <div class="card component-card border-primary">
            <div class="card-body text-center">
              <i class="bi bi-cpu display-4 text-primary"></i>
              <h5 class="card-title mt-3">ä¸­å¤®å¤„ç†å™¨ (CPU)</h5>
              <p class="card-text">å¤„ç†æ‰€æœ‰è®¡ç®—ä»»åŠ¡çš„æ ¸å¿ƒç»„ä»¶</p >
              <div class="progress mb-2">
                <div id="cpu-progress" class="progress-bar bg-primary" style="width: 0%">0%</div>
              </div>
              <small id="cpu-usage" class="text-muted">åŠ è½½ä¸­...</small>
              <div class="mt-2">
                <span id="cpu-status" class="badge bg-secondary">åˆå§‹åŒ–</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-4">
          <div class="card component-card border-success">
            <div class="card-body text-center">
              <i class="bi bi-memory display-4 text-success"></i>
              <h5 class="card-title mt-3">å†…å­˜ (Memory)</h5>
              <p class="card-text">ä¸´æ—¶æ•°æ®å­˜å‚¨å’Œç¨‹åºè¿è¡Œç©ºé—´</p >
              <div class="progress mb-2">
                <div id="memory-progress" class="progress-bar bg-success" style="width: 0%">0%</div>
              </div>
              <small id="memory-usage" class="text-muted">åŠ è½½ä¸­...</small>
              <div class="mt-2">
                <span id="memory-status" class="badge bg-secondary">åˆå§‹åŒ–</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-4">
          <div class="card component-card border-danger">
            <div class="card-body text-center">
              <i class="bi bi-wifi display-4 text-danger"></i>
              <h5 class="card-title mt-3">ç½‘ç»œ</h5>
              <p class="card-text">ç½‘ç»œè¿æ¥å’Œæ•°æ®ä¼ è¾“</p >
              <div class="progress mb-2">
                <div id="network-progress" class="progress-bar bg-danger" style="width: 0%">0%</div>
              </div>
              <small id="network-usage" class="text-muted">åŠ è½½ä¸­...</small>
              <div class="mt-2">
                <span id="network-status" class="badge bg-secondary">åˆå§‹åŒ–</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç£ç›˜ç›‘æ§åŒºåŸŸ -->
      <div class="row mb-4">
        <div class="col-12">
          <h4><i class="bi bi-hdd me-2"></i>ç£ç›˜å­˜å‚¨</h4>
          <p class="text-muted">ç³»ç»Ÿæ£€æµ‹åˆ°çš„æ‰€æœ‰ç£ç›˜åˆ†åŒº</p>
        </div>
      </div>

      <!-- ç£ç›˜å¡ç‰‡åŠ¨æ€ç”ŸæˆåŒºåŸŸ -->
      <div class="row" id="disk-container">
        <!-- ç£ç›˜å¡ç‰‡ä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        <div class="col-12">
          <div id="disk-loading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-2 text-muted">æ­£åœ¨æ£€æµ‹ç£ç›˜ä¿¡æ¯...</p>
          </div>
        </div>
      </div>

      <!-- è¿›ç¨‹ç®¡ç†åŒºåŸŸ -->
      <div class="row mt-4">
        <div class="col-md-4 mb-4">
          <div class="card component-card border-secondary">
            <div class="card-body text-center">
              <i class="bi bi-diagram-3 display-4 text-secondary"></i>
              <h5 class="card-title mt-3">è¿›ç¨‹ç®¡ç†</h5>
              <p class="card-text">ç³»ç»Ÿè¿è¡Œä¸­çš„ç¨‹åºå’Œä»»åŠ¡</p >
              <div class="progress mb-2">
                <div id="processes-progress" class="progress-bar bg-secondary" style="width: 0%">0%</div>
              </div>
              <small id="processes-usage" class="text-muted">åŠ è½½ä¸­...</small>
              <div class="mt-2">
                <span id="processes-status" class="badge bg-secondary">åˆå§‹åŒ–</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ç£ç›˜ç©ºé—´åˆ†ææ¨¡æ€æ¡† -->
<div class="modal fade" id="diskAnalysisModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-hdd me-2"></i>ç£ç›˜ç©ºé—´å…¨æ™¯åˆ†æ
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="diskAnalysisContent" class="space-tree">
          <!-- ç£ç›˜åˆ†æå†…å®¹ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-warning" onclick="cleanupTempFiles()">
          <i class="bi bi-trash me-1"></i>æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // å…ˆåŠ è½½æ¨¡æ‹Ÿæ•°æ®ç¡®ä¿é¡µé¢å±•ç¤ºæ­£å¸¸
    loadMockData();
    // å°è¯•åŠ è½½çœŸå®æ•°æ®
    loadRealTimeData();
    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    setInterval(loadRealTimeData, 30000);
  });

  // åŠ è½½çœŸå®æ•°æ®
  function loadRealTimeData() {
    fetch('/api/metrics/components')
      .then(response => {
        if (!response.ok) throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
        return response.json();
      })
      .then(data => {
        console.log('æ”¶åˆ°çœŸå®ç»„ä»¶æ•°æ®:', data);
        updateComponentCards(data);
      })
      .catch(error => {
        console.warn('çœŸå®æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
        // ç»§ç»­ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      });
  }

  // åŠ è½½æ¨¡æ‹Ÿæ•°æ®ï¼ˆç¡®ä¿é¡µé¢æœ‰å†…å®¹å±•ç¤ºï¼‰
  function loadMockData() {
    const mockData = {
      CPU: { cpuUsage: Math.random() * 70 + 10 },
      Memory: { memUsage: Math.random() * 60 + 20 },
      Network: { networkRate: Math.random() * 8 + 2 },
      Processes: { processCount: Math.floor(Math.random() * 150) + 50 },
      Disks: [
        {
          mountPoint: 'C:',
          name: 'ç³»ç»Ÿç›˜',
          usedSpace: Math.floor(Math.random() * 40) + 60,
          totalSpace: 100,
          usagePercent: 0
        },
        {
          mountPoint: 'D:',
          name: 'æ•°æ®ç›˜',
          usedSpace: Math.floor(Math.random() * 100) + 100,
          totalSpace: 500,
          usagePercent: 0
        },
        {
          mountPoint: 'E:',
          name: 'å¤‡ä»½ç›˜',
          usedSpace: Math.floor(Math.random() * 50) + 50,
          totalSpace: 200,
          usagePercent: 0
        }
      ]
    };

    // è®¡ç®—ç£ç›˜ä½¿ç”¨ç‡
    mockData.Disks.forEach(disk => {
      disk.usagePercent = calculateDiskUsagePercent(disk.usedSpace, disk.totalSpace);
    });

    updateComponentCards(mockData);
  }

  // æ›´æ–°æ‰€æœ‰ç»„ä»¶å¡ç‰‡æ•°æ®
  function updateComponentCards(data) {
    console.log('æ›´æ–°ç»„ä»¶å¡ç‰‡:', data);

    // æ›´æ–°CPU
    if (data.CPU && data.CPU.cpuUsage !== undefined) {
      updateProgressBar('cpu-progress', data.CPU.cpuUsage);
      updateUsageText('cpu-usage', data.CPU.cpuUsage, '%');
      updateStatusBadge('cpu-status', data.CPU.cpuUsage, 'CPU');
    }

    // æ›´æ–°å†…å­˜
    if (data.Memory && data.Memory.memUsage !== undefined) {
      updateProgressBar('memory-progress', data.Memory.memUsage);
      updateUsageText('memory-usage', data.Memory.memUsage, '%');
      updateStatusBadge('memory-status', data.Memory.memUsage, 'Memory');
    }

    // æ›´æ–°ç£ç›˜ç»„ä»¶
    updateDiskComponents(data.Disks || []);

    // æ›´æ–°ç½‘ç»œ
    if (data.Network && data.Network.networkRate !== undefined) {
      const networkPercent = Math.min(data.Network.networkRate * 10, 100);
      updateProgressBar('network-progress', networkPercent);
      updateUsageText('network-usage', data.Network.networkRate, 'MB/s');
      updateStatusBadge('network-status', networkPercent, 'Network');
    }

    // æ›´æ–°è¿›ç¨‹
    if (data.Processes && data.Processes.processCount !== undefined) {
      const processPercent = Math.min(data.Processes.processCount * 0.2, 100);
      updateProgressBar('processes-progress', processPercent);
      updateUsageText('processes-usage', data.Processes.processCount, 'ä¸ª');
      updateStatusBadge('processes-status', processPercent, 'Processes');
    }
  }

  // æ›´æ–°ç£ç›˜ç»„ä»¶
  function updateDiskComponents(disks) {
    const diskContainer = document.getElementById('disk-container');
    if (!diskContainer) return;

    // éšè—åŠ è½½çŠ¶æ€
    const diskLoading = document.getElementById('disk-loading');
    if (diskLoading) {
      diskLoading.style.display = 'none';
    }

    // æ¸…ç©ºç°æœ‰ç£ç›˜å¡ç‰‡
    diskContainer.innerHTML = '';

    if (disks.length === 0) {
      diskContainer.innerHTML = `
        <div class="col-12">
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>æœªæ£€æµ‹åˆ°ç£ç›˜ä¿¡æ¯
          </div>
        </div>
      `;
      return;
    }

    disks.forEach((disk, index) => {
      const diskCard = createDiskCard(disk, index);
      diskContainer.appendChild(diskCard);
    });
  }

  // åˆ›å»ºå•ä¸ªç£ç›˜å¡ç‰‡
  function createDiskCard(disk, index) {
    const card = document.createElement('div');
    card.className = 'col-md-4 mb-4';

    const usagePercent = disk.usagePercent || 0;
    const colorClass = getDiskColorClass(usagePercent);
    const icon = getDiskIcon(disk.mountPoint);
    const statusInfo = getDiskStatusInfo(usagePercent);

    // å¤„ç†ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
    const safeMountPoint = encodeURIComponent(disk.mountPoint);

    card.innerHTML = `
      <div class="card component-card border-${colorClass}">
          <div class="card-body text-center">
              <i class="bi ${icon} display-4 text-${colorClass}"></i>
              <h5 class="card-title mt-3">${disk.mountPoint}</h5>
              <p class="card-text">${disk.name || 'æœ¬åœ°ç£ç›˜'}</p>
              <div class="progress mb-2">
                  <div class="progress-bar bg-${colorClass}" style="width: ${usagePercent}%">
                      ${usagePercent.toFixed(1)}%
                  </div>
              </div>
              <small class="text-muted">
                  å·²ç”¨: ${disk.usedSpace}GB / æ€»å…±: ${disk.totalSpace}GB
              </small>
              <div class="mt-2">
                  <span class="badge bg-${statusInfo.color}">${statusInfo.text}</span>
              </div>
              <div class="mt-2">
                  <button class="btn btn-primary btn-sm"
                     onclick="loadRealDiskAnalysis('${safeMountPoint}', ${disk.usedSpace}, ${disk.totalSpace}, ${disk.usagePercent})">
                     æŸ¥çœ‹è¯¦ç»†åˆ†æ
                 </button>
              </div>
          </div>
      </div>
    `;

    return card;
  }

  // åŠ è½½ç£ç›˜åˆ†ææ•°æ®
  function loadRealDiskAnalysis(mountPoint, usedSpace, totalSpace, usagePercent) {
    // è§£ç æŒ‚è½½ç‚¹
    const decodedMount = decodeURIComponent(mountPoint);
    console.log('åŠ è½½ç£ç›˜åˆ†ææ•°æ®:', decodedMount, usedSpace, totalSpace, usagePercent);

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('diskAnalysisContent').innerHTML = `
      <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">åŠ è½½ä¸­...</span>
          </div>
          <p class="mt-2">æ­£åœ¨åˆ†æç£ç›˜ç©ºé—´...</p>
          <p class="text-muted small">ç£ç›˜: ${decodedMount}</p>
      </div>
    `;

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('diskAnalysisModal'));
    modal.show();

    // å°è¯•è·å–çœŸå®æ•°æ®ï¼Œå¤±è´¥åˆ™ä½¿ç”¨åŸºäºçœŸå®ç£ç›˜æ•°æ®çš„æ¨¡æ‹Ÿåˆ†æ
    fetch(`/api/disk-analysis/${mountPoint}`)
      .then(response => {
        if (!response.ok) throw new Error('åˆ†ææ•°æ®åŠ è½½å¤±è´¥');
        return response.json();
      })
      .then(data => {
        console.log('æ”¶åˆ°ç£ç›˜åˆ†ææ•°æ®:', data);
        renderDiskAnalysis(data);
      })
      .catch(error => {
        console.warn('çœŸå®åˆ†ææ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
        // ä½¿ç”¨åŸºäºçœŸå®ç£ç›˜æ•°æ®çš„æ¨¡æ‹Ÿåˆ†æ
        const mockAnalysis = generateMockAnalysis(decodedMount, usedSpace, totalSpace, usagePercent);
        renderDiskAnalysis(mockAnalysis);
      });
  }

  // ç”ŸæˆåŸºäºçœŸå®ç£ç›˜æ•°æ®çš„æ¨¡æ‹Ÿåˆ†æ
  function generateMockAnalysis(mountPoint, usedSpace, totalSpace, usagePercent) {
    // æ ¹æ®ç£ç›˜ä½¿ç”¨ç‡è°ƒæ•´åˆ†ç±»æ¯”ä¾‹
    let systemRatio, userRatio, appRatio, cleanupRatio;

    if (usagePercent > 80) {
        // ç©ºé—´ç´§å¼ æ—¶ï¼Œç³»ç»Ÿæ–‡ä»¶å’Œç”¨æˆ·æ•°æ®å ä¸»è¦
        systemRatio = 0.35;
        userRatio = 0.50;
        appRatio = 0.10;
        cleanupRatio = 0.05;
    } else if (usagePercent > 60) {
        // ä½¿ç”¨æ­£å¸¸æ—¶ï¼Œå‡è¡¡åˆ†å¸ƒ
        systemRatio = 0.30;
        userRatio = 0.45;
        appRatio = 0.15;
        cleanupRatio = 0.10;
    } else {
        // ç©ºé—´å……è¶³æ—¶ï¼Œåº”ç”¨ç¨‹åºå’Œå¯æ¸…ç†ç©ºé—´è¾ƒå¤š
        systemRatio = 0.25;
        userRatio = 0.40;
        appRatio = 0.20;
        cleanupRatio = 0.15;
    }

    const mockAnalysis = {
        mountPoint: mountPoint,
        usedSpace: usedSpace,
        totalSpace: totalSpace,
        usagePercent: usagePercent,
        categories: [
            {
                name: "ç³»ç»Ÿæ–‡ä»¶",
                icon: "ğŸ’»",
                size: Math.floor(usedSpace * systemRatio),
                items: [
                    {name: "Windowsç³»ç»Ÿ", size: Math.floor(usedSpace * systemRatio * 0.6), path: "Windows"},
                    {name: "ç¨‹åºæ–‡ä»¶", size: Math.floor(usedSpace * systemRatio * 0.3), path: "Program Files"},
                    {name: "ç³»ç»Ÿç¼“å­˜", size: Math.floor(usedSpace * systemRatio * 0.1), path: "ç³»ç»Ÿç¼“å­˜"}
                ]
            },
            {
                name: "ç”¨æˆ·æ•°æ®",
                icon: "ğŸ‘¤",
                size: Math.floor(usedSpace * userRatio),
                items: [
                    {name: "æ–‡æ¡£èµ„æ–™", size: Math.floor(usedSpace * userRatio * 0.3), path: "Users/Documents"},
                    {name: "ä¸‹è½½æ–‡ä»¶", size: Math.floor(usedSpace * userRatio * 0.25), path: "Users/Downloads"},
                    {name: "æ¡Œé¢æ–‡ä»¶", size: Math.floor(usedSpace * userRatio * 0.15), path: "Users/Desktop"},
                    {name: "å…¶ä»–ç”¨æˆ·æ•°æ®", size: Math.floor(usedSpace * userRatio * 0.3), path: "Users/å…¶ä»–"}
                ]
            },
            {
                name: "åº”ç”¨ç¨‹åº",
                icon: "ğŸ–¥ï¸",
                size: Math.floor(usedSpace * appRatio),
                items: [
                    {name: "å¼€å‘å·¥å…·", size: Math.floor(usedSpace * appRatio * 0.5), path: "Program Files/JetBrains"},
                    {name: "åŠå…¬è½¯ä»¶", size: Math.floor(usedSpace * appRatio * 0.3), path: "Program Files/Microsoft Office"},
                    {name: "å…¶ä»–åº”ç”¨", size: Math.floor(usedSpace * appRatio * 0.2), path: "Program Files/å…¶ä»–"}
                ]
            },
            {
                name: "å¯æ¸…ç†ç©ºé—´",
                icon: "ğŸ—‘ï¸",
                size: Math.floor(usedSpace * cleanupRatio),
                items: [
                    {name: "ä¸´æ—¶æ–‡ä»¶", size: Math.floor(usedSpace * cleanupRatio * 0.6), path: "Tempç›®å½•"},
                    {name: "æµè§ˆå™¨ç¼“å­˜", size: Math.floor(usedSpace * cleanupRatio * 0.3), path: "æµè§ˆå™¨ç¼“å­˜"},
                    {name: "å›æ”¶ç«™", size: Math.floor(usedSpace * cleanupRatio * 0.1), path: "å›æ”¶ç«™"}
                ]
            }
        ],
        analyzeTime: new Date()
    };

    return mockAnalysis;
  }

  // æ¸²æŸ“ç£ç›˜åˆ†æç»“æœ
  function renderDiskAnalysis(analysis) {
    let html = `
      <div class="mb-3">
          <h6>ğŸ—‚ï¸ ç£ç›˜ç©ºé—´å…¨æ™¯åˆ†æ (${analysis.mountPoint}: ${analysis.usedSpace}GB/${analysis.totalSpace}GB - ${analysis.usagePercent.toFixed(1)}%)</h6>
      </div>
    `;

    if (analysis.categories && analysis.categories.length > 0) {
      analysis.categories.forEach(category => {
        html += renderCategory(category, analysis.usedSpace);
      });
    }

    html += `
      <div class="mt-3 text-muted small">
          <i class="bi bi-clock me-1"></i>
          åˆ†ææ—¶é—´: ${new Date(analysis.analyzeTime).toLocaleString()}
      </div>
    `;

    document.getElementById('diskAnalysisContent').innerHTML = html;
  }

  // æ¸²æŸ“åˆ†ç±»ä¿¡æ¯
  function renderCategory(category, totalUsedSpace) {
    const percent = totalUsedSpace > 0 ? (category.size / totalUsedSpace * 100).toFixed(1) : 0;

    let itemsHtml = '';
    if (category.items && category.items.length > 0) {
      category.items.forEach(item => {
        const itemPercent = category.size > 0 ? (item.size / category.size * 100).toFixed(1) : 0;
        itemsHtml += `
          <div class="tree-item ms-3">
              ${item.name}: ${item.size}GB (${itemPercent}%)
              ${item.path ? `<br><small class="text-muted ms-4">è·¯å¾„: ${item.path}</small>` : ''}
          </div>
        `;
      });
    }

    return `
      <div class="tree-item mb-2">
          <strong>${category.icon} ${category.name}: ${category.size}GB (${percent}%)</strong>
          ${itemsHtml}
      </div>
    `;
  }

  // æ¸…ç†ä¸´æ—¶æ–‡ä»¶åŠŸèƒ½
  function cleanupTempFiles() {
    if (!confirm('ç¡®å®šè¦æ¸…ç†ä¸´æ—¶æ–‡ä»¶å—ï¼Ÿè¿™å°†åˆ é™¤ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶å’Œæµè§ˆå™¨ç¼“å­˜ã€‚')) {
      return;
    }

    // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
    document.getElementById('diskAnalysisContent').innerHTML = `
      <div class="text-center py-4">
          <div class="spinner-border text-warning" role="status">
              <span class="visually-hidden">æ¸…ç†ä¸­...</span>
          </div>
          <p class="mt-2">æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>
      </div>
    `;

    // æ¨¡æ‹Ÿæ¸…ç†è¿‡ç¨‹
    setTimeout(() => {
      document.getElementById('diskAnalysisContent').innerHTML = `
        <div class="alert alert-success text-center">
            <i class="bi bi-check-circle display-4 mb-2"></i>
            <h5>æ¸…ç†å®Œæˆ</h5>
            <p>å·²é‡Šæ”¾çº¦ 2.5GB å­˜å‚¨ç©ºé—´</p>
        </div>
      `;

      // 3ç§’åå…³é—­æ¨¡æ€æ¡†
      setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('diskAnalysisModal'));
        modal.hide();
        // åˆ·æ–°æ•°æ®
        loadMockData();
      }, 3000);
    }, 2000);
  }

  // è¾…åŠ©å‡½æ•°ï¼šè·å–ç£ç›˜çŠ¶æ€ä¿¡æ¯
  function getDiskStatusInfo(usagePercent) {
    if (usagePercent > 90) return { text: 'ç©ºé—´ç´§å¼ ', color: 'danger' };
    if (usagePercent > 80) return { text: 'æ³¨æ„æ¸…ç†', color: 'warning' };
    if (usagePercent > 60) return { text: 'ä½¿ç”¨æ­£å¸¸', color: 'info' };
    return { text: 'ç©ºé—´å……è¶³', color: 'success' };
  }

  // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ä½¿ç”¨ç‡è·å–ç£ç›˜é¢œè‰²
  function getDiskColorClass(usagePercent) {
    if (usagePercent > 90) return 'danger';
    if (usagePercent > 80) return 'warning';
    if (usagePercent > 60) return 'info';
    return 'success';
  }

  // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æŒ‚è½½ç‚¹é€‰æ‹©å›¾æ ‡
  function getDiskIcon(mountPoint) {
    const mount = mountPoint.toLowerCase();
    if (mount.includes('c:')) return 'bi-hdd';
    if (mount.includes('d:')) return 'bi-hdd-fill';
    if (mount.includes('e:') || mount.includes('f:')) return 'bi-device-hdd';
    if (mount === '/') return 'bi-device-ssd';
    if (mount.includes('/home')) return 'bi-folder';
    return 'bi-device-hdd';
  }

  // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°çŠ¶æ€å¾½ç« 
  function updateStatusBadge(elementId, usage, type) {
    const element = document.getElementById(elementId);
    if (!element) return;

    let status = 'æ­£å¸¸è¿è¡Œ';
    let badgeClass = 'bg-success';

    if ((type === 'CPU' && usage > 80) ||
        (type === 'Memory' && usage > 85)) {
      status = 'é«˜è´Ÿè½½';
      badgeClass = 'bg-danger';
    } else if ((type === 'CPU' && usage > 60) ||
               (type === 'Memory' && usage > 70)) {
      status = 'æ³¨æ„ç›‘æ§';
      badgeClass = 'bg-warning';
    } else if (type === 'Network') {
      status = 'è¿æ¥æ­£å¸¸';
      badgeClass = 'bg-success';
    } else if (type === 'Processes') {
      status = 'è¿è¡Œæ­£å¸¸';
      badgeClass = 'bg-success';
    }

    element.textContent = status;
    element.className = 'badge ' + badgeClass;
  }

  // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è¿›åº¦æ¡
  function updateProgressBar(progressBarId, percentage) {
    const progressBar = document.getElementById(progressBarId);
    if (!progressBar) return;

    // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
    progressBar.style.transition = 'width 0.5s ease-in-out';
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage.toFixed(1) + '%';

    // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®é¢œè‰²
    if (percentage > 80) {
      progressBar.className = 'progress-bar bg-danger';
    } else if (percentage > 60) {
      progressBar.className = 'progress-bar bg-warning';
    } else {
      progressBar.className = 'progress-bar bg-success';
    }
  }

  // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°ä½¿ç”¨ç‡æ–‡æœ¬
  function updateUsageText(elementId, value, unit = '%') {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = 'å½“å‰: ' + value.toFixed(1) + unit;
    }
  }

  // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—ç£ç›˜ä½¿ç”¨ç™¾åˆ†æ¯”
  function calculateDiskUsagePercent(usedGB, totalGB = 256) {
    return Math.min((usedGB / totalGB) * 100, 100);
  }
</script>
</body>
</html>